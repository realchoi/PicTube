# Context
Filename: Task Analysis.md
Created On: 2025-09-06
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
在设置页面中添加一个"通用（General）"的设置tab，并在其中添加app界面语言的设置选项，为后续扩展其他通用设置项做准备。

# Project Overview
PicTube是一个macOS图片查看应用，已具备完整的多语言支持架构（中英文），使用SwiftUI TabView管理设置页面，目前包含快捷键、显示、缓存三个设置标签。需要扩展添加通用设置标签，首先实现语言选择功能。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

**现有架构分析：**

1. **设置页面结构**：
   - 使用SwiftUI TabView架构，位于`SettingsView.swift`
   - 设置窗口尺寸固定为500x400
   - 目前有三个tab：Keyboard、Display、Cache
   - 使用SettingsTab枚举管理标签页

2. **多语言支持现状**：
   - 已建立完整多语言架构，支持中英文
   - 使用NSLocalizedString进行本地化处理
   - 语言文件路径：`Languages/zh-Hans.lproj/`和`Languages/en.lproj/`
   - 所有UI文本已完成本地化

3. **设置管理系统**：
   - AppSettings类使用@AppStorage和@Published管理设置
   - 支持UserDefaults持久化存储
   - 具备设置验证机制
   - 有完善的枚举系统和协议支持

4. **语言切换技术约束**：
   - macOS中NSLocalizedString在应用启动时确定
   - 实时语言切换需要特殊实现或应用重启
   - 需要考虑本地化资源的动态加载

5. **架构扩展点**：
   - SettingsTab枚举需要添加general案例
   - AppSettings需要新增语言设置属性
   - 需要创建GeneralSettingsView.swift
   - 多语言文件需要添加相关字符串

**技术依赖关系：**
- SwiftUI TabView管理多个设置页面
- AppSettings作为统一设置管理器
- NSLocalizedString提供多语言支持
- UserDefaults提供设置持久化

**现有代码文件：**
- `PicTube/Views/Settings/SettingsView.swift`
- `PicTube/Models/AppSettings.swift`
- `Languages/*/Localizable.strings`

# Proposed Solution (Populated by INNOVATE mode)

## 语言选择功能的解决方案分析

### 方案对比评估

#### 方案一：系统级语言设置引导
**优势：** 遵循macOS原生行为，与其他原生应用一致，技术实现简单
**劣势：** 用户体验相对复杂，需要退出应用并访问系统设置

#### 方案二：应用内语言选择 + 重启提醒
**优势：** 在应用内提供便利的语言选择界面，设置持久化到UserDefaults
**劣势：** 仍需重启应用生效，用户体验有一定延迟感

#### 方案三：动态语言切换实现
**优势：** 提供最佳用户体验，选择后立即生效，无需重启
**劣势：** 技术实现复杂，需要自定义本地化系统，替代NSLocalizedString

### 推荐的平衡方案（方案二增强版）

**核心设计理念：**
在技术可行性和用户体验之间找到最佳平衡点，实现应用内语言选择功能，结合友好的用户提示机制。

**技术架构方案：**

1. **语言枚举系统**：
   - 创建AppLanguage枚举：system（跟随系统）、chinese（中文）、english（英文）
   - 支持未来扩展更多语言选项

2. **设置存储机制**：
   - 在AppSettings中添加语言设置属性
   - 使用@AppStorage进行UserDefaults持久化
   - 支持设置验证和默认值管理

3. **通用设置界面**：
   - 创建GeneralSettingsView，采用分组式布局设计
   - 语言设置作为"界面设置"分组的首个选项
   - 为后续通用设置项预留扩展空间

4. **用户体验优化**：
   - 语言选择后显示温和的重启提醒
   - 提供清晰的选项说明和当前状态指示
   - 保持与现有设置页面的视觉一致性

**扩展性架构设计：**
通用设置页面设计为模块化结构，便于后续添加：
- 主题选择设置
- 应用启动行为
- 文件关联配置
- 界面显示偏好
- 其他系统级设置项

**界面分组规划：**
- **界面设置组**：语言选择、主题设置（预留）
- **行为设置组**：启动选项、文件处理（预留）
- **系统集成组**：文件关联、通知（预留）

这种方案在保持技术实现简洁的同时，为用户提供良好的设置体验，并建立了可扩展的通用设置架构基础。

# Implementation Plan (Generated by PLAN mode)

## 详细技术规格

### 1. AppLanguage 枚举系统
**文件：** `PicTube/Models/AppSettings.swift`
**说明：** 创建完整的语言选择枚举系统
- 添加 AppLanguage 枚举：system（跟随系统）、chinese（中文）、english（英文）
- 实现 CaseIterable、Identifiable、KeySelectable 协议
- 添加 displayName 属性用于 UI 显示
- 添加 localeIdentifier 属性用于系统对接
- 提供 availableLanguages() 静态方法

### 2. AppSettings 类扩展
**文件：** `PicTube/Models/AppSettings.swift`
**说明：** 扩展应用设置管理功能
- 添加 @AppStorage("appLanguage") 属性存储语言偏好
- 添加 @Published var appLanguage 用于 UI 双向绑定
- 在 SettingsTab 枚举中添加 general 案例
- 在 resetToDefaults() 方法中添加 general 分支处理
- 在 init() 方法中初始化语言设置加载

### 3. 多语言资源更新
**文件：** `Languages/zh-Hans.lproj/Localizable.strings`
**文件：** `Languages/en.lproj/Localizable.strings`
**说明：** 添加通用设置页面的本地化字符串
- 添加 "general_tab" = "通用" / "General"
- 添加 "general_settings_title" = "通用设置" / "General Settings"
- 添加 "interface_group" = "界面设置" / "Interface Settings"
- 添加 "app_language_label" = "应用语言:" / "App Language:"
- 添加 "language_system" = "跟随系统" / "Follow System"
- 添加 "language_chinese" = "简体中文" / "Simplified Chinese"
- 添加 "language_english" = "English" / "English"
- 添加重启提醒相关字符串

### 4. GeneralSettingsView 创建
**文件：** `PicTube/Views/Settings/GeneralSettingsView.swift`
**说明：** 创建通用设置页面视图
- 创建新的 SwiftUI 视图文件
- 实现分组式界面布局（GroupBox 或类似组件）
- 添加语言选择 Picker 组件，绑定到 appSettings.appLanguage
- 实现语言变更时的温和用户提示
- 保持与现有设置页面的视觉一致性和间距

### 5. SettingsView 集成更新
**文件：** `PicTube/Views/Settings/SettingsView.swift`
**说明：** 集成新的通用设置标签页
- 在 TabView 中添加 GeneralSettingsView 作为首个标签页
- 更新标签页排序：General -> Keyboard -> Display -> Cache
- 在 onChange 监听器中添加对 general 设置的验证支持
- 确保窗口尺寸仍然适配所有标签页内容

## 实施步骤检查清单

```
Implementation Checklist:
1. 在 AppSettings.swift 中创建 AppLanguage 枚举及相关属性
2. 扩展 SettingsTab 枚举，添加 general 案例
3. 在 AppSettings 类中添加语言设置存储和管理功能
4. 更新中文 Localizable.strings，添加通用设置相关字符串
5. 更新英文 Localizable.strings，添加通用设置相关字符串
6. 创建 GeneralSettingsView.swift 文件
7. 实现 GeneralSettingsView 的界面布局和语言选择功能
8. 更新 SettingsView.swift，集成 GeneralSettingsView 标签页
9. 调整标签页顺序，确保 General 位于首位
10. 测试语言选择功能和设置持久化
11. 验证多语言环境下的界面显示
12. 确认与现有设置页面的视觉一致性
```

